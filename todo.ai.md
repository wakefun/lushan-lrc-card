# todo

- [x] 我需要做一个一个歌词播放的PWA应用，主要面向移动端的手机用户，播放标准的lrc歌词，不需要播放歌曲，便于演唱会现场的弱网环境下使用，提前缓存db.json中的数据到页面中。一个离线可用的歌词本，首页是一个歌手选择页面，使用水墨风格,根据不同歌手的歌曲数量，山的大小也不一样。点击乐队，直接进入歌词卡片页面，播放歌词，支持手动上下滑动调节进度。左右滑动则切换该乐队的歌曲。要有卡片切换的动画。基于我的需求，告诉我项目需要使用什么那些框架，主要的技术逻辑和难点是什么，不要直接生成代码，只需要规划任务，并更新到 task.md中

## 实施阶段

需求分析和拆解在task.md中，完成下方任务。每一个Phase都必须和codex进行讨论分析，并以codex为准，gemini负责页面绘制。

### Phase 1: 项目基础

- [x] 初始化 Vite + React + TS 项目
- [x] 安装依赖：vite-plugin-pwa, framer-motion, zustand, tailwindcss, idb-keyval
- [x] 配置 PWA manifest
- [x] 创建数据类型定义（Artist, Song, LyricLine）
- [x] 实现 LRC 解析工具函数
- [x] 实现数据存储服务（IndexedDB 读写封装）

### Phase 2: 首页（歌手选择）

- [x] 歌手列表布局
- [x] 水墨山水 SVG 组件（大小随歌曲数量变化）
- [x] SVG 滤镜实现水墨效果
- [x] 点击歌手进入歌词页

### Phase 3: 歌词卡片页

- [x] 全屏卡片布局（歌名 + 歌词区域）
- [x] 歌词渲染，高亮当前行
- [x] 垂直手势：拖动调整歌词进度
- [x] 水平手势：左右滑动切换歌曲
- [x] 卡片切换动画（AnimatePresence）

### Phase 4: PWA 与性能

- [x] 配置 Service Worker 预缓存静态资源
- [x] 实现双保险数据加载（SW Cache → IndexedDB fallback）
- [x] 添加离线提示 UI
- [x] Screen Wake Lock API（防止屏幕熄灭）

### Phase 5: 视觉打磨

- [x] 纸张纹理背景
- [x] 滑动物理效果调优（阻尼/弹簧）
- [x] 夜间模式

### 问题反馈与修复

问题修复时，先和codex讨论分析原因，UI交互优化时，以gemini为主。

- [x] 乐队的山体大小不再和歌曲数量关联，而是像呼吸一样，每隔3秒随机三个乐队的大小变大1.5-2倍数，循环不断，而且注意动画的连贯，比如前三个乐队的山体在2秒时候变得最大，接着恢复原本大小，后续三个山应该在2秒的时候就要开始变大。具体的动画细节和时间把控，不用参考我的，自行设计一套符合呼吸感的动画节奏。
- [x] 歌词播放有问题，播放页刚开始就居中展示，最前面高亮的都没展示出来，应该是中间始终展示高亮的歌词，歌词自动向上滚动。
- [x] 歌词播放页没有卡片堆叠的感觉，播放页外部包裹容器应该是斜着的，能够看到卡片的厚度，看到下面堆叠的卡片。
- [x] 左右滑动应该是整个播放页都有效，而不是只有底部才能左右滑动
- [x] pwa应用在用户未安装到桌面时，应该提示安装

- [x] 保持之前的排列，一行两个乐队，也就是一行两座山；
- [x] 山体大小渐变的动画有问题，山体大小渐变，山顶的文字（乐队名）保持不变，始终显示。动画应该要有连贯的呼吸感，要有此起彼伏的感觉，目前的动画是三个结束后才播放另一组，非常的僵硬。
- [x] 暗黑模式下，播放页的卡片感不足，加一下边缘的高光。
- [x] 同时提升整体的卡片堆叠感，卡片可以更小一点。
- [x] 高亮的歌词，字体大小更大一点。
- [x] 播放页底部的进度条似乎进度展示有问题，请检查；底部文字只需要提示可以左右滑动切换歌曲即可；

**ui修改务必和和gemini确认方案**

- [x] 山体大小渐变的动画要慢一点，像呼吸一样舒缓
- [x] 山体右下方表示阴影的凹陷区域，变小，不要那么大，每座山的这个区域大小随机，不要一样。
- [x] 山顶的乐队名修改样式，将文字放到山体后面，文字发着金光，像太阳从后面照亮山体一样，一定要非常细致的处理这个特效。
- [x] 播放页去除进度条展示，卡片可以更加小一点，多加一些堆叠感。可以有散乱堆叠的感觉，而不是朝着一个方向斜着，卡片可以正着放置，通过底部散乱伸出的卡片制造堆叠的感觉。

- [x] 去除多少首的文字，只需要展示乐队名。文字颜色调整，暗黑模式使用白色的月光，日间模式使用日出时的太阳颜色。不要环绕的旋转光效，只需要一缕光 从山后射出来的感觉。
- [x] 山体的形状可以更加丰富一点，每座山的形状差异更大一些。
- [x] 呼吸的动画可以稍微快点，现在太慢了。
- [x] 播放页面并没有堆叠感，应该是下方有左右伸出的卡片的感觉。并且随着滑动会发生数量的变化。

- [x] 乐队字体大小调整，现在超过了三个字就换行，不好。至少保证保证五个字不换行；降低字的位置，不要在山顶之上，而是在山后，冒出文字，山顶遮挡一小部分文字。
- [x] 日间文字的颜色继续修改，使用日出的红色。有中国画的风格色。
- [x] 去除山底下的阴影，使用小山和大山构成层峦叠嶂的中国水墨风格，每个小山随机大小，每个乐队的小山数量不一样，按照顺序分别是：3,3,3,0,4,3,3,3
- [x] 播放页面的卡片堆叠感始终没有做出来，请参考这张图片实现，`duidie.png`，要有底下左右露出卡片的堆叠感。底部堆叠的数量和当前歌曲后面剩余播放歌曲数量相关联。

- [x] 首页，去除山体一缕光射出来的效果，改为文字周边发着光晕；文字位置需要调整， 当前文字太靠下了，应该是文字在山顶，只被山尖遮住了一点点；文字大小要大一点
- [x] 群山的标题改为《庐山音乐节》
- [x] 日间模式背景应该有山间云雾缭绕的水墨感，有河流在山间流动，配合着山体的呼吸感渐变；夜间模式，河流反射透出白光，周边有繁星点点闪烁。
- [x] 日间模式和夜间模式切换的按钮优化，日间模式时，按钮为银白月亮，夜间模式时，按钮为淡红太阳，要有水墨风感觉。
- [x] 日间模式的背景进行修改，不要黄黄的宣纸感觉，要白透一点，和山间云雾缭绕的水墨风相辅相成。
- [x] 你的理解不对，河流和云雾是作为整个背景层面的，不是围绕单个山体去构建，进行修改。要有整个背景云雾缭绕的感觉，然后山头在云间呼吸着。符合中国水墨风的审美。夜间模式的群星也是一样作为整体背景，随机在背景中闪烁，闪烁的星光要有泼墨一样的动画特效。
- [x] 夜间模式切换的月亮按钮，可以更加亮一点。
- [x] 云雾缭绕的感觉还是错误的，不是在底下流动，而是一缕缕白云在整个画面上吹动，要有水墨画的烟雾感觉，将山轻轻遮掩。
- [x] 去除河流特效。去除有下角新增的印章。
- [x] 日间模式的纸张感，要更加细腻，目前太粗糙了。
- [x] 播放页面，日间模式，高亮的歌词使用红日的颜色。
- [x] 经过测试，日间模式下的云雾层没有显示，检查并修复；夜间模式的繁星层，覆盖区域有问题，部分区域未覆盖，应该是覆盖整个页面的。
- [x] 夜间模式似乎会随机有背景光，但是随着山头呼吸，背景光没有变换区域，需要修复；
- [x] 繁星层的星光要有泼墨感，快速闪出变亮，不规则形状和随机的大小，然后变淡。
- [x] 经过测试，日间模式的云雾层看不见，继续修复这个问题，此问题已经修复了几次了，一直没有解决，务必仔细检查发现问题，与codex和gemini一起单独就这个问题讨论。
- [x] 繁星层不是进入页面生成随机位置后就固定了，应该是一直随机有地方亮，同时亮的数量控制在8-20,随机；星星形状应该和泼墨一样，是水花溅开的特效，这样才有水墨风的感觉。
- [x] 小山的轮廓和大小要稍微明显一点。

- [x] 日间模式的白云效果不对，请回退删除，然后重新设计，参考UI图进行实现，随机的缕缕白云从画面左右飘入飘出。参考图：`ui/baiyun.png`
- [x] 夜间模式的泼墨形状不对，参考图片: `ui/pomo.png`, 实现随机的泼墨水花感觉；繁星不是一起亮，都是随机时间亮，只是限制同一段时间内的数量，例如3秒内只允许8-20颗星星在闪烁。
- [x] 日间模式下的白云效果完全不满足需求，将参考图片: `ui/pomo.png`交给gemini重新实现。
- [x] 夜间模式下不要有白云飘过。
- [x] 夜间模式下的星星大小缩小为当前的三分之一，形状要更加丰富和随机一点。

- [x] 日间模式下的祥云，我已经准备了5个svg，文件路径为：`ui/xy1.svg` `ui/xy2.svg` `ui/xy3.svg` `ui/xy4.svg` `ui/xy5.svg`，基于现有的svg，调整内部填充颜色，加入适当的渐变，使其整体更加符合水墨风格的视觉效果，然后将调整后的svg应用于首页，需要注意一点，所有的svg的云朵朝向都是对应从右往左吹的，当生成从左往右吹的云朵时，应该先将svg做y轴的反向处理。
- [x] 夜间模式下的泼墨效果，参考svg：`ui/pomo.svg`，基于这个形状生成五种泼墨的svg，然后应用于夜间模式中，星星的随机大小的上限值可以比当前的更大一点。
- [x] 日间模式，祥云应该是偏向纯白色，然后加上一点渐变，祥云的大小要更小一点，运动速度更快一点。基于 `ui/xy1.svg` `ui/xy2.svg` `ui/xy3.svg` `ui/xy4.svg` `ui/xy5.svg`修改后的svg应该放入assets目录保存，不要直接写在代码中。
- [x] 夜间模式，繁星的svg应该放入assets目录保存，不要直接写在代码中，繁星闪烁时候，要加上一层光晕，更加凸显出闪烁的光效。
- [x] 日间模式，祥云小一点，颜色更白一点，降低透明度。`src/assets/clouds/cloud3.svg`的生成有问题，明显比其他svg尺寸小很多，导致在画面中也明显小很多，请参考`ui/xy3.svg`重新生成。
- [x] 夜间模式，繁星的光晕可以更加强烈一点，繁星的svg根据`ui/pomo.svg`重新生成，只需要基于原版略微修改边缘即可。繁星的svg修改，直接交给gemini处理。
- [x] 日间模式，祥云可以纯白一点，不要透明度，使用css给云朵加一点从右上方打来的日光的光晕，从而提高云朵的饱满感。祥云的大小变小一点。目前祥云的飞行方向是反的，生成的svg应该是从右往左飞，从左往右飞的祥云才需要将svg做y轴反向。
- [x] 夜间模式，去除繁星，删除相关代码和svg文件；改为随机绽放的小烟花，使用传统国画的色彩，不要过度鲜艳，烟火的形状和大小都随机，绽放的一瞬间可以亮一点艳一点。
- [x] 日间模式，云朵的光晕淡一点，只需要点缀的感觉即可，云朵飞行的速度加快一点。不同高度位置应该是随机的，不同位置应该随机刷出不同的云朵。增加一个小彩蛋，双击云朵时，云朵会加速迅速飞出。
- [x] 夜间模式，参考UI稿生成烟花动画，`ui/yanhua.webp` ，要有绽放的动画，随机绽放的烟花，使用传统国画的色彩，不要过度鲜艳，烟火的形状和大小都随机，绽放的一瞬间可以亮一点艳一点。
- [x] 夜间模式，去除现有的烟花代码和相关静态资源，我已安装了`canvas-confetti`库，最新的api文档已下载：`ui/canvas-confetti.api.md`，使用canvas-confetti实现烟花特效，颜色使用国画色彩，线条细。参考官网案例`ui/firework.demo.js`。
- [x] 日间模式，小彩蛋测试没有生效，双击云朵时，云朵会加速迅速飞出，检查并修复问题。云朵的svg填充为纯白色，不要有透明度，再次确认。
- [x] 夜间模式，已去除canvas-confetti依赖，实现的烟花效果太差，移除相关代码。交给gemini，基于ui图`ui/yanhua.webp`实现一个烟花动画库，支持指定颜色和绽放时长等参数，如果依赖第三方库，直接安装。
- [x] 日间模式，进行动画性能优化，感觉祥云飞行的时候很卡，有掉帧。
- [x] 日间模式，加快祥云飞行速度。祥云上的css的光效更淡一点。双击云朵没有加快飞行，检查原因。
- [x] 夜间模式，放弃烟花特效，去除相关代码；回滚到之前的繁星方案，基于 `ui/pomo.svg` 生成边缘微小修改的5个泼墨风格的svg，然后加上闪烁的光效。具体可以查看todo文档中已完成的需求对于繁星方案的描述。
- [x] 日间模式，上次修改后出现了问题，右上角切换按钮无法点击了。检查并修复。云朵双击加速飞行不生效的问题依然存在。
- [x] 夜间模式，去除生成的5个繁星svg，直接使用 ui/pomo.svg 作为繁星，加上css光晕即可。
- [x] 夜间模式，繁星不是一起亮，都是随机时间亮，只是限制同一段时间内的数量，例如3秒内只允许8-20颗星星在闪烁。繁星层不是进入页面生成随机位置后就固定了，应该是一直随机有地方亮，同时亮的数量控制在8-20。
- [x] 日间模式，与codex一起单独探讨为什么双击云朵之后，对应的云朵没有快速飞行出画面。
- [x] 首页新增一个音乐开关，默认播放public/lushan.mp3，点击可以关闭音乐。注意音乐播放不能阻塞页面渲染，音乐最好能标记缓存，避免离线失效。
- [x] 音乐播放图标放在左上角，和日夜切换图标对称，大小也一致。
- [x] 音乐播放按钮，页面刚进入时，因为用户和页面没有交互，默认自动播放策略会拦截自动播放，此时显示了一个小黄点，当用户点击后，已经具备交互，此时应该开始立即从头播放，但是目前页面是点击后静音了，需要再点击一次才能播放，修复这个问题。
- [x] icon修改，替换为`public/icons/logo-192.png` `public/icons/logo-512.png` `public/icons/logo-1024.png`
- [x] pwa添加提示，文案优化，告知用户添加后即可离线查看庐山跨年演出会的所有歌词。使用国画红色字提醒。`点击下方分享按钮 ⬆ 选择"添加到主屏幕"` 改为 `浏览器菜单-选择"添加到主屏幕"`
- [x] icon修改有遗漏，index.html中未更新icon，pwa添加提示框中未使用icon图片
- [x] pwa提示框的字体大小增大一点
- [x] 歌词本 三个字的字体大小也增大一点
- [x] 项目有使用网络字体，进行优化，将字体文件放到本地目录，由网站自行提供字体网络服务，避免其他网络影响。
- [x] 字体文件实在是太大了，我决定不使用在线加载字体的方式了，去除多余文件。直接使用系统默认字体，基于你的经验，设置一些常见的符合页面风格的非衬线字体为优先字体。
- [x] 播放页面使用浏览器返回按钮时，应该返回到首页，当前有问题，直接关闭了页面。
- [x] 优化播放页上下滑动的逻辑，应该是直接滑动歌词，播放进度自动跳转到当前高亮歌词。目前的体验似乎是上下滑动，滑动的是播放进度，这样体验不流畅，不符合直觉。
- [x] 播放页的左右滑动似乎有些卡顿，不够灵敏，检查原因并修复。
- [x] 新增一个微信提示页面，检查到当前浏览器是微信浏览器，则提示用户使用浏览器打开，提供一个按钮，点击即可复制链接。页面风格依旧保持水墨风格，使用大字和红色标记元素，类似古代通缉犯告示的风格。
- [x] 微信提示页面，该页面只有日间模式，不要夜间模式。点击复制链接按钮后，toast提示用户：链接已复制到剪切板，请打开浏览器访问
- [x] 微信提示页面，点击复制链接按钮后，toast没显示出来，检查并修复问题
- [x] 微信提示页面，toast还是显示不出来，是不是层级的原因
- [x] 微信提示页面，经过测试我发现问题原因了，点击复制链接按钮后，复制失败了，根本没有复制，所以toast也没展示出来。代码报错了：Uncaught TypeError: Cannot read properties of undefined (reading 'writeText')
- [x] 微信提示页面和首页都出现了高度不适配问题，超出直接隐藏了，部分手机显示不完整，立即修复这个问题，并检查歌词页面是否有隐患。
- [x] 首页切换按钮，月亮加一个淡黑色的背景，避免白色的月亮看不见
- [x] 夜间模式，星星闪烁去掉svg，使用星星闪烁动画，大小、亮度、位置都随机，要有绽放的感觉。
- [x] 按钮的月亮往左上挪一挪，目前背景和月亮重叠了，略微挪动一点，不要居中。
- [x] 星光闪烁的特效有问题，交给gemini重做。
- [x] 星光闪烁特效相关代码全部去除。重写一个流星特效。
- [x] 夜间模式下，流星从右边随机划落，水墨风格的流星拖尾，
- [x] 流星特效完全错了，重做。应该是从右上方朝着左下角运动，然后慢慢拉出一条淡淡的白色拖尾，流星雨的感觉，同时最多5个流星同时划过。流星运动过程中要有明暗变化，就和真实世界的流星一样。同时符合整体画面的水墨画风格。
- [x] 参考liuxing.demo.html重写流星特效。
- [x] 放慢流星的速度，越长的流星越慢。
- [x] 日间模式，云朵上方加上一点点红晕，颜色像是被第一缕山间日出照射。
- [x] 日间模式，云朵的光晕顶部直接截断了，检查问题。降低一点点光晕，可以再淡一点点。
- [x] 夜间模式，流星的最大宽度减半。
- [x] 日间模式，顶部光晕可以加强一点。
- [x] 夜间模式，速度整体减慢。
- [x] 歌词播放页面，左右滑动有些过于灵敏，导致上下滑动会不小心出发左右滑动。
- [x] 日夜切换按钮顺序改变，日间显示太阳，夜间显示月亮。
- [x] 歌曲播放bug修复，当进入页面用户无操作时，音乐不能播放，图标显示黄点，用户和页面发生交互，黄点消失，到这里都是正常的，但是歌曲没有自动播放，处理这个问题。
- [x] 月亮按钮被改得出问题了，本来是在右下角的，现在跑到左上角去了，修复问题。
- [x] 因为改变了按钮的月亮和太阳的显示，然后本身是有一个旋转动画的，是这个导致了最终月亮的位置不对，重新修复这个问题。
- [x] 微信提醒页面，修复复制按钮点击后动画卡顿的问题。
- [x] 切换按钮，月亮按钮光晕被截断成了正方形，修复问题，适当增强一点光晕效果，去除之前的淡黑色底色。
- [x] 微信提示界面的按钮还是有问题，动画效果不对，点击完成之后应该是恢复空白底色而不是一直是红色底色，整体动画效果也不流畅。
- [x] 微信提示界面的按钮，动画太快了，都看不清，而且按钮为什么和顶部提示联动了，顶部提示应该是固定3秒消失，而不是和按钮动画同步消失。立即修复！
- [x] 微信提示界面还是有bug，多次点击按钮，会导致提示突然消失。
- [x] 切换按钮的月亮还是有UI问题，周边的光晕被截成方形了，具体查看我给你附加的截图。
- [x] 月亮的光晕有些过于规则了，应该是明暗和扩散都是有些不规则，符合水墨画的风格。
- [x] 云朵动画卡顿并非云朵本身，而是首页山体"呼吸"使用 `framer-motion` 在主线程驱动多组件同步 `scale/translate`，导致主线程周期性忙碌，云朵出现"匀速一段后停顿再快进"。

    ```md
  - 核心修改方法：将 `src/components/MountainCard.tsx` 中的呼吸动画从 `framer-motion` 改为纯 CSS 过渡：
  - 移除 `framer-motion` 的 `motion/Variants` 引用与 `mountainVariants`
  - `motion.button`、`motion.div` 改为原生 `button`、`div`
  - 使用 `transform` + `transition`（示例：`transform: isBreathing ? 'translate3d(0, -5px, 0) scale(1.05)' : 'translate3d(0, 0, 0) scale(1)'`，`transition: 'transform 3s cubic-bezier(0.45, 0, 0.55, 1)'`，并加 `will-change: transform`）
  ```
- [x] 云朵飞行改为匀速飞行，不要ease-out
- [x] 增大当前的山体起伏幅度
- [x] 云朵顶部的光晕被截断了，检查并修复。
- [x] 月亮图标不要过于完美的弧度，假如一点小小的裂纹，类似毛笔笔触下的间隙，从而更有水墨画的感觉。
- [x] 首页标题下方新增一行红色小字：跨年版 2025-2026 。日间模式使用传统国画的朱砂色，夜间模式使用朱砂色对应的暗色。
- [x] 夜间模式，每66秒钟会有一次流星雨大爆发，数量为66颗
